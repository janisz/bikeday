/*! bikeday 27-04-2014 */
function geocode(a,b){var c=new google.maps.Geocoder;c.geocode({address:a},function(c,d){d==google.maps.GeocoderStatus.OK?b(c[0].geometry.location):alert("Location "+a+"not found")})}function calcRoute(a,b,c,d){directionsDisplayWalkToStation.setMap(map),directionsDisplayWalkFromStation.setMap(map),directionsDisplayBike.setMap(map),new google.maps.Marker({position:a,map:map,icon:"img/start-walk.png"}),new google.maps.Marker({position:b,map:map,icon:"img/start-bike.png"}),new google.maps.Marker({position:c,map:map,icon:"img/stop-bike.png"}),new google.maps.Marker({position:d,map:map,icon:"img/stop-walk.png"});var e=new google.maps.LatLngBounds;e.extend(a),e.extend(d),e.extend(b),e.extend(c),console.log("Bounding to ",e),map.panToBounds(e),map.fitBounds(e);var f={origin:a,destination:b,transitOptions:{departureTime:new Date(1337675679473)},travelMode:google.maps.TravelMode.WALKING},g={origin:b,destination:c,transitOptions:{departureTime:new Date(1337675679473)},travelMode:google.maps.TravelMode.BICYCLING},h={origin:c,destination:d,transitOptions:{departureTime:new Date(1337675679473)},travelMode:google.maps.TravelMode.WALKING};directionsService.route(f,function(a,b){console.log("Status",b),b==google.maps.DirectionsStatus.OK?(console.log("Set directions"),directionsDisplayWalkToStation.setDirections(a)):console.error("Error",b);var c=a.routes[0].legs[0].duration.value;$("#toStationDuration").html(a.routes[0].legs[0].duration.text),console.log("Walk to station:",a.routes[0].legs[0].duration),directionsService.route(g,function(a,b){console.log("Status",b),b==google.maps.DirectionsStatus.OK?(console.log("Set bicycling directions"),directionsDisplayBike.setDirections(a)):console.error("Error",b),c+=a.routes[0].legs[0].duration.value,console.log("Biking duration:",a.routes[0].legs[0].duration),directionsService.route(h,function(a,b){console.log("Status",b),b==google.maps.DirectionsStatus.OK?(console.log("Set directions"),directionsDisplayWalkFromStation.setDirections(a)):console.error("Error",b),c+=a.routes[0].legs[0].duration.value,$("#toEndDuration").html(a.routes[0].legs[0].duration.text);var d=parseInt($("#hour").val(),10)+c/3600%24;$("#endTime").html(Math.ceil(d)),console.log("Total duration",c),console.log("Walk to end:",a.routes[0].legs[0].duration),weather($("#hour").val(),Math.ceil(c/3600),function(a){console.log("Result",a),endHour=a.endHour,startHour=a.startHour,$("#weather").html(a.message+"<img src='"+a.icon+"'/>"),sunsetSunrise(endHour,function(a){$("#sunsetSunrise").html(""),$("#sunsetSunrise").html(startHour>a.sunsetHour&&24>startHour||startHour<a.sunsetHour&&startHour>=0&&startHour<a.sunriseHour?"You will be biking in the dark, after sunset at "+a.sunsetHour+":"+a.sunsetMinute:"You won't make it before sunset at "+a.sunsetHour+":"+a.sunsetMinute)})})})})})}function findStations(a){$.ajax({type:"GET",url:"mockdata/veturilo.xml",dataType:"xml",success:function(b){var c=[];$(b).find("place").each(function(){var a=$(this),b={name:a.attr("name"),lat:a.attr("lat"),lng:a.attr("lng"),bikes:a.attr("bikes"),racks:a.attr("bike_racks")};c.push(b)}),a(c)}})}function findNearestStation(a,b){var c,d=null;return $.each(b,function(e,f){var g=distanceSquare(a,f);(null===d||c>g&&"0"!=b.bikes)&&(d=f,c=g)}),d}function weather(a,b,c){$.ajax({url:"http://api.wunderground.com/api/086afffe3fa8ba4d/hourly/q/Poland/Warsaw.json",dataType:"jsonp",success:function(d){var e=d.hourly_forecast[0].temp.metric,f=d.hourly_forecast[0].FCTTIME.hour,g=a-f,h=[];h[0]="Thunderstorms",h[1]="Thunderstorm",h[2]="Chance of Thunderstorms",h[3]="Chance of Thunderstorm",h[4]="Snow",h[5]="Chance of Snow",h[6]="Sleet",h[7]="Chance of Sleet",h[8]="Freezing Rain",h[9]="Rain",h[10]="Chance of Freezing Rain",h[11]="Chance of Rain",h[12]="Scattered Clouds",h[13]="Overcast",h[14]="Cloudy",h[15]="Mostly Cloudy",h[16]="Partly Cloudy",h[17]="Flurries",h[18]="Fog",h[19]="Haze",h[20]="Sunny",h[21]="Mostly Sunny",h[22]="Partly Sunny",h[23]="Clear",h[24]="Unknown";for(var i=100,k=100,l=g;b>l;l++)for(j=0;25>j;++j)d.hourly_forecast[l].condition===h[j]&&i>j&&(i=j,k=l);var m={};2>i&&(m.message="Current temperature in Warsaw is "+e+".</br> There will be thunderstorms during your trip"),i>1&&4>i&&(m.message="Current temperature in Warsaw is "+e+".</br> There might be thunderstorms during your trip"),4==i&&(m.message="Current temperature in Warsaw is "+e+".</br> It will be snowing during your trip"),5==i&&(m.message="Current temperature in Warsaw is "+e+".</br> It might be snowing during your trip"),6==i&&(m.message="Current temperature in Warsaw is "+e+".</br> It will be sleeting during your trip"),7==i&&(m.message="Current temperature in Warsaw is "+e+".</br> It might be sleeting during your trip"),(8==i||9==i)&&(m.message="Current temperature in Warsaw is "+e+".</br> It will be raining during your trip"),(10==i||11==i)&&(m.message="Current temperature in Warsaw is "+e+".</br> It might be raining during your trip"),i>11&&20>i&&(m.message="Current temperature in Warsaw is "+e+".</br> It will be cloudy during your trip"),i>19&&(m.message="Current temperature in Warsaw is "+e+".</br> It will be great weather during your trip"),console.log(d.hourly_forecast),m.icon=d.hourly_forecast[0].icon_url,m.endHour=d.hourly_forecast[0].offset+b.hour,m.startHour=a,c(m)}})}function sunsetSunrise(a,b){$.ajax({url:"http://api.wunderground.com/api/086afffe3fa8ba4d/astronomy/q/Poland/Warsaw.json",dataType:"jsonp",success:function(a){var c={sunriseHour:a.moon_phase.sunrise.hour,sunriseMinute:a.moon_phase.sunrise.minute,sunsetHour:a.moon_phase.sunset.hour,sunsetMinute:a.moon_phase.sunset.minute};b(c)}})}$(document).ready(function(){$("#hour").val(((new Date).getHours()+1)%24),$("#searchButton").click(function(){weather($("#hour").val(),2,function(a){console.log(a),endHour=a.endHour,startHour=a.startHour,$("#weather").html(a.message+"<img src='"+a.icon+"'/>"),sunsetSunrise(endHour,function(a){$("#sunsetSunrise").html(startHour>a.sunsetHour&&24>startHour||startHour<a.sunsetHour&&startHour>=0&&startHour<a.sunriseHour?"You will be biking in the dark, after sunset at "+a.sunsetHour+":"+a.sunsetMinute:"You won't make it before sunset at "+a.sunsetHour+":"+a.sunsetMinute)})});var a,b,c,d;return geocode($("#from").val(),function(e){a={location:e,lat:e.lat(),lng:e.lng()},$("#resultFrom").text(e),console.log("from",a),geocode($("#to").val(),function(e){c={location:e,lat:e.lat(),lng:e.lng()},$("#resultTo").text(e),console.log("to",c),findStations(function(e){b=findNearestStation(a,e),console.log("fromStation",b),$("#fromStation").text(b.name),$("#fromStationBikes").text(b.bikes),d=findNearestStation(c,e),console.log("toStation",d),$("#toStation").text(d.name);var f=new google.maps.LatLng(a.lat,a.lng),g=new google.maps.LatLng(c.lat,c.lng),h=new google.maps.LatLng(b.lat,b.lng),i=new google.maps.LatLng(d.lat,d.lng);calcRoute(f,h,i,g)})})}),!1})});var mapOptions={zoom:12,center:new google.maps.LatLng(52.2324,21.0127),mapTypeId:google.maps.MapTypeId.ROADMAP,panControl:!0,panControlOptions:{position:google.maps.ControlPosition.RIGHT_TOP},zoomControl:!0,zoomControlOptions:{style:google.maps.ZoomControlStyle.LARGE,position:google.maps.ControlPosition.RIGHT_TOP},scaleControl:!0,scaleControlOptions:{position:google.maps.ControlPosition.RIGHT_TOP},streetViewControl:!0,streetViewControlOptions:{position:google.maps.ControlPosition.RIGHT_TOP}},map=new google.maps.Map(document.getElementById("map-canvas"),mapOptions),bikeLayer=new google.maps.BicyclingLayer,markers={startWalk:new google.maps.Marker({map:map,icon:"img/start-walk.png"}),startBike:new google.maps.Marker({map:map,icon:"img/start-bike.png"}),stopBike:new google.maps.Marker({map:map,icon:"img/stop-bike.png"}),stopWalk:new google.maps.Marker({map:map,icon:"img/stop-walk.png"})},map=new google.maps.Map(document.getElementById("map-canvas"),mapOptions),bikeLayer=new google.maps.BicyclingLayer;bikeLayer.setMap(map);var rendererWalkToStationsOptions=new google.maps.Polyline({strokeColor:"#00FF00"}),rendererBikingOptions=new google.maps.Polyline({strokeColor:"#FF0000"}),rendererFromStationOptions=new google.maps.Polyline({strokeColor:"#0000FF"}),directionsService=new google.maps.DirectionsService,directionsDisplayWalkToStation=new google.maps.DirectionsRenderer({preserveViewport:!0,polylineOptions:rendererWalkToStationsOptions,markerOptions:{visible:!1}}),directionsDisplayWalkFromStation=new google.maps.DirectionsRenderer({preserveViewport:!0,polylineOptions:rendererFromStationOptions,markerOptions:{visible:!1}}),directionsDisplayBike=new google.maps.DirectionsRenderer({preserveViewport:!0,polylineOptions:rendererBikingOptions,markerOptions:{visible:!1}}),distanceSquare=function(a,b){var c=a.lat-b.lat,d=a.lng-b.lng;return c*c+d*d};